name: DashPayiOS
options:
  bundleIdPrefix: com.dash
  deploymentTarget:
    iOS: "17.0"
  createIntermediateGroups: true
  
packages:
  SwiftDashCoreSDK:
    path: ../rust-dashcore/swift-dash-core-sdk
  
settings:
  base:
    IPHONEOS_DEPLOYMENT_TARGET: "17.0"
    SWIFT_VERSION: "5.9"
    LIBRARY_SEARCH_PATHS: 
      - "$(PROJECT_DIR)/DashPayiOS/Libraries"
      - "$(PROJECT_DIR)/DashPayiOS/Libraries/DashSDK.xcframework/ios-arm64-simulator"
    FRAMEWORK_SEARCH_PATHS:
      - "$(PROJECT_DIR)/DashPayiOS/Libraries"
    # SWIFT_INCLUDE_PATHS handled by Swift Package Manager
    OTHER_LDFLAGS:
      - "-lc++"
      - "-ObjC"
      
targets:
  DashPayiOS:
    type: application
    platform: iOS
    sources:
      - path: DashPayiOS
        excludes:
          - "**/*.md"
          - "**/Package.swift"
          - "Tests/**"
          - "Libraries/backup/**"
    dependencies:
      - package: SwiftDashCoreSDK
        product: SwiftDashCoreSDK
      - package: SwiftDashCoreSDK
        product: KeyWalletFFISwift
      - framework: DashPayiOS/Libraries/DashSDK.xcframework
        embed: true
        link: true
      - sdk: libc++.tbd
      - sdk: libz.tbd
      - sdk: Foundation.framework
      - sdk: Security.framework
      - sdk: SystemConfiguration.framework
    preBuildScripts:
      - script: |
          if [ "${PLATFORM_NAME}" = "iphonesimulator" ]; then
            ${SRCROOT}/select-library.sh sim
          else
            ${SRCROOT}/select-library.sh ios
          fi
        name: "Select FFI Libraries"
        basedOnDependencyAnalysis: false
    settings:
      base:
        INFOPLIST_FILE: DashPayiOS/Info.plist
        PRODUCT_BUNDLE_IDENTIFIER: com.dash.wallet.ios
        PRODUCT_NAME: DashPay
        CODE_SIGN_STYLE: Automatic
        DEVELOPMENT_TEAM: ""
        EXCLUDED_ARCHS[sdk=iphonesimulator*]: x86_64
        # SWIFT_INCLUDE_PATHS handled by Swift Package Manager
        OTHER_LDFLAGS:
          - "-lc++"
          - "-ObjC"
          - "-dead_strip"
        
  DashPayiOSTests:
    type: bundle.unit-test
    platform: iOS
    sources: 
      - DashPayiOSTests
    dependencies:
      - target: DashPayiOS
    settings:
      TEST_HOST: "$(BUILT_PRODUCTS_DIR)/DashPay.app/DashPay"
      
  DashPayiOSUITests:
    type: bundle.ui-testing
    platform: iOS
    sources:
      - DashPayiOSUITests
    dependencies:
      - target: DashPayiOS
